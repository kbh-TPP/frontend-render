## 前端渲染优化

### 一、目录

1、浏览器渲染原理

2、如何优化分层

3、网页动画

4、H5 Canvas的优化

### 二、页面是如何显示出来的？

![Alt text](/2-1.png)

先简单总体说下浏览器是如何显示一个页面的，要经过哪些步骤？
一个网页要显示出来需要经过加载、解析、排版和渲染几个过程。

加载：就是指从网上把页面资源都拉过来；

解析：就是分析html文件生成dom树；

排版：是开始计算各个节点的显示的位置坐标；

渲染：就是将dom树中各个节点都画出来最终呈现出网页的可视画面。之前跟一些前端同学打过交道，可能很多同学口中的网页渲染说的是页面元素该显示在什么位置或者什么样式。这其实大部分说的是页面排版的过程。

![Alt text](/2-2.png)

那么网页真正渲染的过程是这样的。主要涉及下面几个线程：render线程、合成线程以及光栅化线程。

不知道前端同学对线程是否了解。线程可以理解为：每个线程都是独立的执行任务，相互之间是异步的，能同时并发执行各自的任务。在来看这张图，renderer线程是内核运行的主线程，其中解析排版以及js执行都在这个线程，也只有这个线程能访问和操作dom树，所以只要跟dom树沾边的操作或任务就只能在这个线程中执行。

合成线程主要工作就是渲染显示。光栅化线程唯一任务就是光栅化了。

接着看流程：排版完成后页面各个元素的位置样式等都确定了。

接着开始录制。录制就是把页面的元素变成一条条绘制的指令。比如在xxx位置画xx图片，在xx位置显示一行文字等等。

录制完成后会将录制好的内容交给合成线程。合成线程会先把整个页面进行分块，一个页面分成若干个小的分块。在逐个将每个分块放到光栅化线程执行光栅化。

光栅化其实就是把之前录制好的指令真正地画成图像。光栅化完成后就形成了一个个分成块的网页的图像。

接着在合成线程根据当前屏幕大小和页面滑动的位置等，选择好要显示的分块，再把这些分块一个个滑到屏幕上。这样我们就看到了网页的显示画面了。

#### 2.1 网页分块渲染

![Alt text](/2-3.png)

前面将页面显示的时候要进行分块。那么为啥要分块呢？

这主要是为了提升操作响应速度。网页都分块了，那么无论如何滑动或者缩放页面，浏览器都能很快地挑出需要显示的分块在合成画到屏幕上。
分块还有一个好处就是可以按照优先级来绘制页面各部分的内容。比如马上需要显示的部分肯定需要最先画出来。

看右侧这张图，浏览器会cache两种分辨率的分块，一个正常分辨率（像右图中的小字编号的分块），一个低分辨率的分代。这主要是为了防止来不及画，低分辨率画地快，有个模糊的画面比显示白色要好很多。

手机浏览器上，猛然滑动页面有时候会看到文字模糊的画面，这就是看到低分辨率分块了。
低分辨率是应急准备的，那么它的优先级肯定比高分辨率高，需要先通过光栅化画出来。

每个分辨率都是先画马上要显示的分块，也就是可见区域的分块。然后离可见区域越近的优先级越高，越早画出来。其实就是从可见的部分一圈圈往外画分块。

#### 2.2 网页分块渲染规则

为了滑动显示效果每个分层会保留至少两种分辨率的分块；

所有分块会根据到可视区域的距离来确定渲染的优先级；

硬件加速分块的载体是OpenGL Texture。

总体一下，页面是分块渲染的。一般会保存两种分辨率的分块。分块是按照优先级来决定谁先画。
现在浏览器都采用硬件加速渲染了。所以分块的载体是opengl的纹理。生成分块纹理的过程叫光栅化（Raster）。有两种另一种是GPU光栅化，就是指分块直接用GPU画的。

#### 2.3 页面分块的GPU光栅化

GPU光栅化速度更快，内存，CPU消耗较少；
目前还无法对包含复杂矢量绘制的页面进行GPU光栅化；
GPU光栅化是未来趋势。

GPU光栅化速度更快，消耗也较少。但是它有个很大的缺点，复杂矢量绘制效率很低，无法采用。
但是GPU光栅化是一个趋势。
对于前端来说，页面中少一些复杂线条是能够提升渲染的光栅化效率的。原来不能用GPU raster的页面，减少复杂线条，就能用GPU raster了。对于能够用GPU raster的页面，减少复杂线条能够提升raster速度。

### 三、网页的分层渲染

![Alt text](/3-1.png)

前面讲了页面是分成块进行渲染的，这里再讲下页面分层渲染。下面这幅图是用chrome浏览器看到的手机版搜狐页面的分层情况。

![Alt text](/3-2.png)

Dom树大家应该都比较熟悉了。这幅图估计也都见过很多遍了，网上一搜到处都是。Dom树排版以后生成了render树。最后的这个graphics layer树基本上就是对应显示的分层。

#### 3.1 分层渲染的优点

最主要的是能够减少不必要的重新绘制，一个层上的变化不会波及周边其它层；
可以实现较复杂加速动画，很多动画分层以后更容易实现；
能够方便实现复杂的CSS样式

#### 3.2 前端控制页面分层如何影响渲染效率？


对于页面分层渲染，前端应该要注意哪些呢？或者是前端应该如何控制页面分层而达到最优的渲染效率呢？

下面通过几个有问题的例子讲起

小豆腐块分层较多。页面整体分层总数量较大。会导致每帧渲染时遍历分层和计算分层位置耗时较长。

第一个例子，腾讯网。

![Alt text](/3-3.png)

腾讯网在android手机上显示的分层情况。可以看到很多新闻条目都被单独分层，像小豆腐块一样。

分层面积虽然不大，但是数量可观。对渲染性能会造成一定的影响。浏览器每帧都会遍历计算所有分层坐标等，还要算分块优先级啥的。分层多了计算量就变大了。
当然现在的一般android手机显示qq.com也没太多问题，影响不至于太大。但是低端手机上性能的影响还是能够体现出来的。这样毕竟会导致低效的渲染。
为啥会造成这样的结果呢。我们来看页面的代码。

上面图片就是这个“galleryinner”是可以左右滑动的，所以设置了transfrom属性。这样浏览器会进行分层。而后面的很多元素设置的position属性值为relative导致也被分层了。

所以就产生很多小块分层。后面这些小分层分层的原因用最新的chrome浏览器可以看到：是它们可能覆盖在一个已经分层的元素上，就是可能覆盖在这个galleryinnner。

第二个例子：可视区域内分层太多且需要绘制面积太大，渲染性能非常差。甚至达到无法正确显示的地步。

![Alt text](/3-4.png)

这个例子类似的页面和模板很常见。一些招聘，广告等都采用这种方式。但是有的这种模板是有渲染问题的，比如这个页面。
所有的页面都在可见区域内。当一层不显示了，就把它旋转90度竖着放在下面。是通过这几行代码实现的。
而浏览器需要渲染和处理可见区域内所有的分层。这个页面的分层总面积非常大，渲染会非常慢。另外，需要非常多的内存来cache渲染内容。
在一些手机上已经超过浏览器的内存使用限制，造成一些地方显示不出来。这个页面很多手机浏览器上都会出现闪烁。

第三个例子：人民网首页

前面举了两个分层多影响渲染性能的例子。那么是不是分层越少越好呢。
我们来看看人民网首页。这个页面比较极端，就一个分层。

![Alt text](/3-5.png)

当页面发生变化时，可以看到绿色框子中的重绘区域。类似的元素和图片左右滑动的效果，在各种手机页面中非常常见。
它们都是元素位置变化，而内容是完全不变的。这种情况如果不分层的话，浏览器每帧都要重绘所有变化的元素。动画的帧率会明显下降。

渲染角度分析：没有分层。页面变化时需要重绘的区域较多。元素内容无变化只有位置发生变化时，可以利用分层来避免重绘。

第四个例子：1号店首页

![Alt text](/3-6.png)

前面几个例子有分层多的，有完全不分层的。我们再来看最后一个例子，一号店的android版首页。
这个页面看起来分层还比较合适。该分层的都分层了。也没有太多分层。
但是~~~~~~~~
这个页面每隔一两秒，分层就发生一次变化。而且变化很大。原本在最底层的很多内容，被单独分成一个层了。
这样底层内容发生变化，需要完全重新绘制。新分出来的层肯定也是要完全重新画的。需要重新绘制的面积非常非常大。
假如像人民网一样完全不分层的话，重绘的面积还没有这么大。这就明显是弄巧成拙了。
为什么会这样呢，看代码。在这里有一个上下滚动的字幕。每隔一段时间会给它设置个transform属性和动画。动画完了再去掉。
这样的话这个元素平常是不分层的，而动画的时候立马进行了分层。动画完了再变回去。
后面其他元素的分层也是设置了position：relative属性引起的。在这里分层变化时，后面一堆元素的分层也跟着变化了。
这样重绘面积非常大，性能会比较差，也很耗电。

渲染角度分析：分层发生大面积变化，由此产生全屏重绘。还不如不分层渲染性能好。

#### 3.3 分层原因

每个浏览器或者不同版本的浏览器分层策略都会不同。但总体应该差不太多。
最常见的几个分层原因：transform、Z-index；硬件加速的video、canvas等；fixed的元素；还有一个常见的容易被忽视的分层原因是下层的元素被分层了。

#### 3.4 Chrome查看分层的工具

![Alt text](/3-7.png)

前面ppt中贴了很多能看分层的图。其实都是用chrome浏览器中的工具看的。
最常用，最稳定的办法是看分层的边缘网格线，这里面也包含分块的网格线。比如我们做内核渲染相关的工作，常年默认都是开着网格线。一眼就能够看出页面分层分块情况。
看网格线还有一个地方在这里，但是有的chrome版本貌似看不了。
还有前面直观地看出3D形状的分层效果图的是在chrome浏览器的设置放在一起 more tools下的layers。不同版本chrome可能位置不一样，我这个是M59的chrome。
这个工具很高大上，其实是chrome实验室功能。不太好用，非常卡很耗内存。
如何控制分层，因为分层的逻辑确实非常复杂，所以最靠谱的方式还是通过工具看分层。再尝试调整。

#### 3.5 到底如何分层才是渲染最优的呢？

分层目的主要是减少重绘，当元素有位置变化时适合分层。
既然浏览器分层的目的主要是减少重绘。那么当元素位置可能产生变化的时候就需要分层。
像下面几个页面的位置不断变化的图片。

![Alt text](/3-8.png)

#### 3.6 静止的元素周围的内容频繁变化的元素需要单独分层。如下图红框中的时间显示。

![Alt text](/3-9.png)

静止的元素周围内容频繁变化的元素需要单独分层。如下面淘宝网首页的这个时间显示。
时间周围的元素基本都是不动的。如果不分层的话，时间每隔1S变一下。浏览器不光要绘制时间这个元素，它底下的元素，还有周边的元素都可能需要重新绘制。
而分层了，就只需要绘制时间这一小块区域了。
淘宝这里确实也是分层了，是用了z-index属性分层的。

#### 3.7 虽然分层能够减少浏览器的重绘。但是物极必反，分层太多则会导致浏览器遍历和计算的耗时变长，分层面积过大会导致渲染所用内存增大。这些都是会影响渲染性能的。

下面这两个图就是刚才说的有问题的例子。他们的问题都是分层太多了，或者面积太大了。
分层只要能够达到减少重绘的目的就好，要防止层爆炸。

![Alt text](/3-10.png)

#### 3.8 哪种方式是渲染较优的？

![Alt text](/3-11.png)

![Alt text](/3-12.png)

红框中图片分层处理方式有两种：

* 所有图片一个长条分层，图片变换时显示长条分层的不同区间。
* 每个图片分一层，不显示的挪到视野左边或右边，显示时挪进来。

第二种是比较优的。原因是：
* 第一种分层个数较多，计算量会比较大。
* 内核会优先绘制离可见区域较近的内容。第一种未显示的分层都在可见区域周围，内核无法判断其渲染优先级。而第二种则可以根据离可见区域的距离来合理安排渲染和cache。

#### 3.9 总结

分层总的原则是：减少渲染重绘面积与减少分层个数和分层总面积。

* 元素只有相对位置变化的需要分层。
* 元素更新比较频繁需要分层。
* 较长较大的页面注意总的分层个数。
* 避免某一块区域分层过多，面积过大。









